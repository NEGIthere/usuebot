# -*- coding: utf-8 -*-

from telegram import (ReplyKeyboardMarkup, ReplyKeyboardHide)
from telegram.ext import (Updater, CommandHandler, MessageHandler, Filters, RegexHandler, ConversationHandler)

import sys
import logging
import datetime
import time
import db_manager
import lessons

reload(sys)
sys.setdefaultencoding('utf8')

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                    level=logging.INFO)

logger = logging.getLogger(__name__)

INSTITUTE, CATHEDRA, DIRECTION, GROUP = range(4)

daysOfWeek =  { "Monday":"–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", 
                "Tuesday":"–í—Ç–æ—Ä–Ω–∏–∫", 
                "Wednesday":"–°—Ä–µ–¥–∞", 
                "Thursday":"–ß–µ—Ç–≤–µ—Ä–≥", 
                "Friday":"–ü—è—Ç–Ω–∏—Ü–∞", 
                "Saturday":"–°—É–±–±–æ—Ç–∞", 
                "Sunday":"–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ" }

lessonsTime = [
    "8.30-10.00",
    "10.10-11.40",
    "11.50-13.20",
    "13.50-15.20",
    "15.30-17.00",
    "17.10-18.40",
    "18.50-20.20",
    "20.30-22.00"
]

subjects = {
    "–ò–Ω—Å—Ç–∏—Ç—É—Ç —ç–∫–æ–Ω–æ–º–∏–∫–∏" : {
        "–ö–∞—Ñ–µ–¥—Ä–∞ –≤–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏": {
            "–í–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å" : ["–í–≠–î-14", "–í–≠–î-15", "–í–≠–î-16-1,2"]  # –í–≠–î
        },
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –º–∏—Ä–æ–≤–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏": {
        #    "–ú–∏—Ä–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞", #
        #},
        "–ö–∞—Ñ–µ–¥—Ä–∞ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–π, –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è": {
            "–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞" : ["–†–≠-13", "–†–≠-14", "–†–≠-15"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞" : ["–≠–ú–∏–°–ü-14", "–≠–ú–∏–°–ü-16"],
            #"–≠–∫–æ–Ω–æ–º–∏–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
            "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å" : ["–≠–ë-13", "–≠–ë-14-1", "–≠–ë-14-2", "–≠–ë-15-1", "–≠–ë-15-2", "–≠–ë-16 (–§–°–ü)", "–≠–ë-16-1", "–≠–ë-16-2,3"],
            #"–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
            #"–≠–∫–æ–Ω–æ–º–∏–∫–∞ –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
            "–ó–µ–º–ª–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –∫–∞–¥–∞—Å—Ç—Ä—ã": ["–ó–ö-13", "–ó–ö-14", "–ó–ö-15"]
            #"–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–µ—Å—Ç–Ω–æ–µ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
            #"–≠–∫–æ–Ω–æ–º–∏–∫–æ-–ø—Ä–∞–≤–æ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            #"–≠–∫–æ–Ω–æ–º–∏–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –¥–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π",
            #"–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–µ—Å—Ç–Ω–æ–µ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",

        },
        "–ö–∞—Ñ–µ–¥—Ä–∞ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π": {
            #"–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–∏—â–µ–≤—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤",
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π": ["–≠–ü-13-1", "–≠–ü-13-2", "–≠–ü-14", "–≠–ü-14-1 2–í–ü–û (–≤–µ—á)", "–≠–ü-15", "–≠–ü-16"]
        },
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–æ–º": {
        #    "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å–æ–º",
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –æ–±—â–µ–π –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏": {
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –¥–µ–ª–æ–≤–æ–≥–æ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞": {
#
        #},
        "–ö–∞—Ñ–µ–¥—Ä–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏": {
            "–õ–æ–≥–∏—Å—Ç–∏–∫–∞": ["–õ–æ–≥-15", "–õ-13", "–õ-14", "–õ-16"], #–õ–û–ì
        },
        #"–ö–∞—Ñ–µ–¥—Ä–∞ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∂–∏–ª–∏—â–Ω–æ–≥–æ, –∫–æ–º–º—É–Ω–∞–ª—å–Ω–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞ –∏ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏": {
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è": {
        #    "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–∞—è —Å–ª—É–∂–±–∞",
        #},
        "–ö–∞—Ñ–µ–¥—Ä–∞ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ –ø—Ä–∞–≤–∞": {
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –ø—Ä–∞–≤–æ": ["–≠–ö–ò–ü-13", "–≠–ö–∏–ü-14", "–≠–ö–∏–ü-15", "–≠–∫–∏–ø-16"],
        }
    },
    "–ò–Ω—Å—Ç–∏—Ç—É—Ç –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π": {
        "–ö–∞—Ñ–µ–¥—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, —ç–∫–æ–Ω–æ–º–µ—Ç—Ä–∏–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∏": {
            "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º" : ["–≠–ú–ê-13", "–≠–ú–ê-14", "–≠–ú–ê-15", "–≠–ú–ê-16-1", "–≠–ú–ê-16-2"], # –≠–ú–ê
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞ –∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞" : ["–ò–í–¢-13", "–ò–í–¢-14", "–ò–í–¢-15", "–ò–í–¢-16"], # –ò–í–¢
            "–ü—Ä–∏–∫–ª–∞–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞" : ["–ü–ò–≠-13-1", "–ü–ò–≠-13-2", "–ü–ò–≠-14-1", "–ü–ò–≠-14-2", "–ü–∏–≠-15", "–ü–ò–≠-16-1,2"], # –ü–ò–≠
        },
        "–ö–∞—Ñ–µ–¥—Ä–∞ –±–∏–∑–Ω–µ—Å-–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∏": {
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å" : ["–ò–ë-14", "–ò–ë-15", "–ò–ë-16"], # –ò–ë
            "–ë–∏–∑–Ω–µ—Å-–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞": ["–ë–ò-13", "–ë–ò-14", "–ë–ò-15", "–ë–ò-16-1", "–ë–ò-16-2"]
        },
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞": {
        #    "–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –≤ —Å–ø–æ—Ä—Ç–µ",
        #    "–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
        #    "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç",
        #    "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–ª—ã–º –±–∏–∑–Ω–µ—Å–æ–º",
        #},
        "–ö–∞—Ñ–µ–¥—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞": {
            "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥" : ["–ú–ê–†-13", "–ú–ê–†-14", "–ú–∞—Ä-15", "–ú–ê–†-15 –§–°–ü2", "–ú–∞—Ä-16"],
            #"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ —Ä–µ–∫–ª–∞–º–∞ –≤ —Å—Ñ–µ—Ä–µ —É—Å–ª—É–≥",
            "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç" : ["–ú–ú-13-1", "–ú–ú-13-2", "–ú–ú-13-3", "–ú–ú-14-1", "–ú–ú-14-2", "–ú–ú-15-1", "–ú–ú-15-2", "–ú–ú-16-1,2"],
            #"–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥",
            #"–†–µ–∫–ª–∞–º–Ω—ã–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç",
        },
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏": {
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–æ—Ü–∏–æ–ª–æ–≥–∏–∏": {
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏": {
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ —ç–∫–æ–Ω–æ–º–∏–∫–∏ —Ç—Ä—É–¥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º": {
        #    "–≠–∫–æ–Ω–æ–º–∏–∫–∞ —Ç—Ä—É–¥–∞",
        #    "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º",
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è –∏ —Å–ø–æ—Ä—Ç–∞": {
#
        #}
    },
    #"–ò–Ω—Å—Ç–∏—Ç—É—Ç —Ç–æ—Ä–≥–æ–≤–ª–∏, –ø–∏—â–µ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ —Å–µ—Ä–≤–∏—Å–∞" : {
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ –∫–æ–º–º–µ—Ä—Ü–∏–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏": {
    #        #–¢–æ—Ä–≥–æ–≤–æ–µ –¥–µ–ª–æ  –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –∫–æ–º–º–µ—Ä—Ü–∏—è 
    #        #–≠–∫–æ–Ω–æ–º–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ –ø–∏—â–µ–≤–æ–π –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏": {
    #        "–ë–∏–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è"
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–∏—Ç–∞–Ω–∏—è": {
    #        "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è"
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã": {
    #        "–¢–æ–≤–∞—Ä–Ω—ã–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç",
    #        "–¢–æ–≤–∞—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –≤ —Å—Ñ–µ—Ä–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ–ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—ã—Ä—å—è",
    #        "–¢–æ–≤–∞—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –≤ —Å—Ñ–µ—Ä–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å—ã—Ä—å—è –∏ –ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤",
    #        "–¢–æ–≤–∞—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
    #        "–¢–æ–≤–∞—Ä–æ–≤–µ–¥–µ–Ω–∏–µ"
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –∏ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º—Å—Ç–≤–∞": {
    #        "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å–µ—Ä–≤–∏—Å" # –°–µ—Ä–≤–∏—Å
    #        "–¢—É—Ä–∏–∑–º" #–ë–∞–∑–æ–≤—ã–π
    #        "–ì–æ—Å—Ç–∏–Ω–∏—á–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å" # –ì–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–µ –¥–µ–ª–æ
    #        "–†–µ—Å—Ç–æ—Ä–∞–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–æ–º": {
    #        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–æ–º"
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ —Ñ–∏–∑–∏–∫–∏ –∏ —Ö–∏–º–∏–∏": {
#
    #    },
    #    "–ö–∞—Ñ–µ–¥—Ä–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤": {
#
    #    }
    #},
    "–ò–Ω—Å—Ç–∏—Ç—É—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –ø—Ä–∞–≤–∞" : {
        '–ö–∞—Ñ–µ–¥—Ä–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤ –∏ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –¥–µ–ª–∞': {
            "–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –¥–µ–ª–æ" : ["–ë–î-13-1", "–ë–î-13-2", "–ë–î-14", "–ë–î-16"], # –ë–î
            #"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä—ã–Ω–∫–∏ –∏ –±–∏—Ä–∂–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
            #"–§–∏–Ω–∞–Ω—Å—ã –∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π —É—á–µ—Ç",
            #"–§–∏–Ω–∞–Ω—Å—ã –∏ –∫—Ä–µ–¥–∏—Ç",

        },
        "–ö–∞—Ñ–µ–¥—Ä–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤": {
            "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å—ã" : ["–ì–ú–§-13", "–ì–ú–§-14", "–ì–ú–§-15"]
            #"–ù–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–ª–æ–≥–æ–≤–æ–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ",
        },
        "–ö–∞—Ñ–µ–¥—Ä–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–æ–≥–æ —É—á—ë—Ç–∞ –∏ –∞—É–¥–∏—Ç–∞": {
            "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π —É—á–µ—Ç, –∞–Ω–∞–ª–∏–∑ –∏ –∞—É–¥–∏—Ç" : ["–ë–£–ê-13", "–ë–£–ê-14-1", "–ë–£–ê-14-1 2–í–ü–û (–≤–µ—á)", "–ë–£–ê-14-2", "–ë–£–ê-15", "–ë–£–ê-16"], # –ë–£–ê
        },
        #"–ö–∞—Ñ–µ–¥—Ä–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞": {
        #    "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç" : [],
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–∞–≤–∞": {
        #    "–ü—Ä–∞–≤–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –æ—Ä–≥–∞–Ω–æ–≤" : [],
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ —Ç–µ–æ—Ä–∏–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –∏ –ø—Ä–∞–≤–∞": {
#
        #},
        #"–ö–∞—Ñ–µ–¥—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∞": {
        #    "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ-–ø—Ä–∞–≤–æ–≤–æ–π" : [],
        #},
        "–ö–∞—Ñ–µ–¥—Ä–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∞": {
            #"–Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è" : [],
            "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤–æ–π" : ["–ì–ü–Æ-15-1 (–§–°–ü)", "–ì–ü–Æ-15-–ö–∏–ü (–§–°–ü)", "–ì–ü–Æ-16 - –ö–∏–ü (–§–°–ü)", "–ì–ü–Æ-16-1 (–§–°–ü)", "–ì–ü–Æ-16-2 (–§–°–ü)"],

        }
    },
    "–ò–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è" : {
        "–ì–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–µ –¥–µ–ª–æ" : ["–ì–î-13", "–ì–î-14", "–ì–î-15", "–ì–î-15 –§–°–ü2", "–ì–î-16"],
        "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": ["–ì–ú–°-13", "–ì–ú–°-14-1", "–ì–ú–°-14-2", "–ì–ú–°-15", "–ì–ú–°-16", "–ì–ú–£-13", "–ì–ú–£-15 –§–°–ü2", "–ì–ú–£-16 (–§–°–ü)"],
    },
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—ã" : {
        "–ó–∞–æ—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ": {
            "–í–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è" : ["–ó–ú-–í–≠–î-16"],
            "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–µ—Å—Ç–Ω–æ–µ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": ["–ó–ú-–ì–£–ú–°-16"],
            "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Ä–∞–∑–≤–µ–¥–∫–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º –±–∏–∑–Ω–µ—Å–µ" : ["–ó–ú-–ö–†–ú–ë-16"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏" : ["–ó–ú-–û–ü–î-16"],
            "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ñ–µ—Ä–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" : ["–ó–ú-–°–ü–ì–£-16"],
            "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è" : ["–ó–ú-–¢–ì–ê-16"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" : ["–ó–ú-–£–ü-16"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç" : ["–ó–ú-–§–∏–ë–ú-16"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π, —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π, –Ω–∞–ª–æ–≥–æ–≤—ã–π —É—á–µ—Ç, –∞–Ω–∞–ª–∏–∑ –∏ –∞—É–¥–∏—Ç" : ["–ó–ú-–§–£–ê-16"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –ø—Ä–∞–≤–æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∏ –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π" : ["–ó–ú-–≠–ö–∏–ü-16"],
        },
        "–û—á–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ": {
            "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–æ—Ç–∏–≤–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ—Ä—Ä—É–ø—Ü–∏–∏": ["–ú-–ë–ì–£-15", "–ú-–ë–ì–£-15-3"],
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞" : ["–ú-–ë–ò-15-3", "–ú-–ë–ò-16"],
            "–í–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è" : ["–ú-–í–≠–î-15", "–ú-–í–≠–î-16-3"],
            "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç –≤ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–µ" : ["–ú-–ì–°–ê-15", "–ú-–ì–°–ê-15-3"],
            "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã" : ["–ú-–ö–ò–°-15", "–ú-–ö–ò–°-16"],
            "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" : ["–ú-–ö–£-16"],
            "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥" : ["–ú-–ú–∏–ë-15", "–ú-–ú–∏–ë-15-3", "–ú-–ú–∏–ë-16", "–ú-–ú–∏–ë-16-3"],
            "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ñ–µ—Ä–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" : ["–ú-–°–ü–ì–£-15", "–ú-–°–ü–ì–£-16-3"],
            "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" : ["–ú-–°–£-15", "–ú-–°–£-16-3"],
            "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è" : ["–ú-–¢–ì–ê-15-3", ],
            "–¢–æ–≤–∞—Ä–Ω—ã–π –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ –∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏ –≤–Ω–µ—à–Ω–µ–π —Ç–æ—Ä–≥–æ–≤–ª–µ" : ["–ú-–¢–ö-16", ],
            "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è" : ["–ú-–¢–ü–ü-15", "–ú-–¢–ü–ü-16"],
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö" : ["–ú-–£–õ–°-15", "–ú-–£–õ–°-15-3"],
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞" : ["–ú-–£–ü-16"],
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏" : ["–ú-–£–ü–†-15", "–ú-–£–ü–†-15-3", "–ú-–£–ü–†-16"],
            "–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –≤ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–º –∏ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–º –±–∏–∑–Ω–µ—Å–µ" : ["–ú-–£–¢–∏–ë-15", "–ú-–£–¢–∏–ë-15-3", "–ú-–£–¢–∏–ë-16"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç" : ["–ú-–§–∏–ë–ú-16", "–ú-–§–∏–ë–ú-16-3"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä—ã–Ω–∫–∏: —É—á–∞—Å—Ç–Ω–∏–∫–∏, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" : ["–ú-–§–†-16"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç" : ["–ú-–§–†–∏–ë–î-15-3 (–§–∏–ë–ú)", "–ú-–§–†–∏–ë–î-15-3 (–§–ö)"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π, —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π, –Ω–∞–ª–æ–≥–æ–≤—ã–π —É—á–µ—Ç, –∞–Ω–∞–ª–∏–∑ –∏ –∞—É–¥–∏—Ç" : ["–ú-–§–£–ê-15", "–ú-–§–£–ê-15-3", "–ú-–§–£–ê-16-3"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è" : ["–ú-–≠–ó-15-3"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –ø—Ä–∞–≤–æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∏ –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π" : ["–ú-–≠–∏–ü-15-3"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –¥–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π" : ["–ú-–≠–ù–î-15", "–ú-–≠–ù–î-15-3"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–æ-–ø—Ä–∞–≤–æ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å" : ["–ú-–≠–ü–ë-15", "–ú-–≠–ü–ë-15-3", "–ú-–≠–ü–ë-16"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º" : ["–ú-–≠–£–ü-15", "–ú-–≠–£–ü-15-3"],
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞ —Ñ–∏—Ä–º—ã" : ["–ú-–≠–§-15", "–ú-–≠–§-16", "–ú-–≠–§-16-3"],
        }
    }
}

def start(bot, update, user_data):
    reply_keyboard = list([x] for x in subjects.keys())
    reply_keyboard.insert(0, ["üïó –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ".decode("utf-8")])

    update.message.reply_text(
        '–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))

    group = db_manager.getGroup(update.message.from_user.id)

    if group:
        user_data["group"] = group

    return INSTITUTE

def send_last_timetable(bot, update, user_data):
    if "group" in user_data:
        sendTimetable(user_data["group"], update)
    else:
        update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç.')
    return INSTITUTE

def institute_choice(bot, update, user_data):
    user = update.message.from_user

    msg = update.message.text.encode("utf-8")

    user_data["institute"] = msg

    if user_data["institute"] == "–ò–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è":
        directions = subjects.get(user_data["institute"])
        reply_keyboard = list([x.decode("utf-8")] for x in directions.keys())

        update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.',
            reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))
        return DIRECTION

    cathedrals = subjects.get(user_data["institute"])

    reply_keyboard = list([x.decode("utf-8")] for x in cathedrals.keys())
    reply_keyboard.insert(0, ["–ù–∞–∑–∞–¥".decode("utf-8")])

    update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ñ–µ–¥—Ä—É.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))

    return CATHEDRA

def cathedra_choice(bot, update, user_data):
    msg = update.message.text.encode("utf-8") # chosen cathedra

    if msg in subjects.get(user_data["institute"]):
        user_data["cathedra"] = msg
        print 'Chosen group' + msg
    else:
        print "No cathedra " + msg
        return CATHEDRA

    directions = subjects.get(user_data["institute"]).get(user_data["cathedra"])
    
    if len(directions) == 0:
        update.message.reply_text('–î–ª—è —ç—Ç–æ–π –∫–∞—Ñ–µ–¥—Ä—ã –ø–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.')
        return CATHEDRA

    reply_keyboard = list([x.decode("utf-8")] for x in directions.keys())
    reply_keyboard.insert(0, ["–ù–∞–∑–∞–¥".decode("utf-8")])

    update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))
    return DIRECTION

def direction_choice(bot, update, user_data):
    msg = update.message.text.encode("utf-8") # chosen direction

    if user_data["institute"] == "–ò–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è":
        s = subjects.get(user_data["institute"])
    else:
        s = subjects.get(user_data["institute"]).get(user_data["cathedra"])

    if msg in s:
        user_data["direction"] = msg
        print 'Chosen direction' + msg
    else:
        print "No direction " + msg
        return DIRECTION
    #logger.info("Gender of %s: %s" % (user.first_name, update.message.text))

    groups = s.get(user_data["direction"])

    reply_keyboard = list([x.decode("utf-8")] for x in groups)
    reply_keyboard.insert(0, ["–ù–∞–∑–∞–¥".decode("utf-8")])

    update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))

    return GROUP

def group_choice(bot, update, user_data):
    msg = update.message.text.encode("utf-8") # chosen group

    if user_data["institute"] == "–ò–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è":
        s = subjects.get(user_data["institute"])
    else:
        s = subjects.get(user_data["institute"]).get(user_data["cathedra"])

    if msg in s.get(user_data["direction"]):
        user_data["group"] = msg
        print 'Chosen group' + msg
    else:
        print "No group " + msg
        return GROUP

    sendTimetable(user_data["group"], update)

    return GROUP

def sendTimetable(name, update):
    tt = db_manager.getTimetable(name)

    if tt is None or len(tt) == 0:
        update.message.reply_text('–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.')
        return GROUP

    assert(len(tt) == 2)

    now = datetime.datetime.now()

    if time.localtime().tm_isdst == 0:
        offset = time.timezone
    else:
        offset = time.altzone
    offset = offset / 60 / 60 * -1

    if offset == 0:
        now = now + datetime.timedelta(hours=5)

    tomorrow = (now + datetime.timedelta(days=1))

    timtableText = "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è _" + name + ('_\n*–ù–∞ —Å–µ–≥–æ–¥–Ω—è* (%s, %s):\n' % (daysOfWeek[now.strftime("%A")], now.strftime("%d.%m.%Y"))) + createTimetableText(tt[0]) + '*–ù–∞ –∑–∞–≤—Ç—Ä–∞* (%s, %s):\n' % (daysOfWeek[tomorrow.strftime("%A")], tomorrow.strftime("%d.%m.%Y")) + createTimetableText(tt[1])
            
    update.message.reply_text(timtableText, parse_mode="Markdown")
    
    db_manager.saveGroup(update.message.from_user.id, name)

    return

def createTimetableText(table):
    timtableText = ""
    n = 0
    for l in table:
        n = n + 1
        if l[0] == "null":
            continue
        timtableText = timtableText + ("  %d. %s - %s, %s, %s\n" % (n, lessonsTime[n], l[0], l[1], l[2]))
    if timtableText == "":
        return "  –ù–µ—É—á–µ–±–Ω—ã–π –¥–µ–Ω—å\n"
    return timtableText

def back_cathedra(bot, update, user_data):
    reply_keyboard = list([x] for x in subjects.keys())
    reply_keyboard.insert(0, ["üïó –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ".decode("utf-8")])

    update.message.reply_text(
        '–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))
    return INSTITUTE

def back_direction(bot, update, user_data):
    if user_data["institute"] == "–ò–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è":
        return back_cathedra(bot, update, user_data)

    cathedrals = subjects.get(user_data["institute"])

    reply_keyboard = list([x.decode("utf-8")] for x in cathedrals.keys())
    reply_keyboard.insert(0, ["–ù–∞–∑–∞–¥".decode("utf-8")])

    update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ñ–µ–¥—Ä—É.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False))

    return CATHEDRA

def back_group(bot, update, user_data):
    if user_data["institute"] == "–ò–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è":
        directions = subjects.get(user_data["institute"])
    else:
        directions = subjects.get(user_data["institute"]).get(user_data["cathedra"])

    reply_keyboard = list([x.decode("utf-8")] for x in directions.keys())
    reply_keyboard.insert(0, ["–ù–∞–∑–∞–¥".decode("utf-8")])

    update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard))

    return DIRECTION

def cancel(bot, update):
    user = update.message.from_user
    logger.info("User %s canceled the conversation." % user.first_name)
    update.message.reply_text('–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!',
                              reply_markup=ReplyKeyboardHide())

    return ConversationHandler.END

def timetable_command(bot, update, user_data):
    group = update.message.text[11:].strip().encode("utf-8") # group

    if group in db_manager.groupNames:
        sendTimetable(group, update)
    else:
        update.message.reply_text('–ù–µ–≤–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã.')
    return

def error(bot, update, error):
    logger.warn('Update "%s" caused error "%s"' % (update, error))


def prt():
    logger.info("Hello?")
    return

def main():
    db_manager.init()

    # job = scheduler.add_job(lessons.updateAllTimeTable, 'interval', minutes=5) # lessons.updateAllTimeTable
    # scheduler.start()

    #lessons.updateAllTimeTable()

    institutesRegex = ('^(' + '|'.join(str(x) for x in subjects.keys()) + ')$').decode("utf-8")
    backRegex = '^(–ù–∞–∑–∞–¥)$'.decode("utf-8")
    lastTimetableRegex = "^(üïó –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ)$".decode("utf-8");

    updater = Updater("315708415:AAFyAAFCl_IHd19hJbqWxaB65UNilzJsCX4")

    dp = updater.dispatcher

    conv_handler = ConversationHandler(
        entry_points = [
            CommandHandler('start', start, pass_user_data=True),
            MessageHandler(Filters.text, start, pass_user_data=True)
        ],

        states = {
            INSTITUTE: [
                RegexHandler(lastTimetableRegex, send_last_timetable, pass_user_data=True),
                RegexHandler(institutesRegex, institute_choice, pass_user_data=True)
            ],
            CATHEDRA: [
                RegexHandler(backRegex, back_cathedra, pass_user_data=True),
                MessageHandler(Filters.text, cathedra_choice, pass_user_data=True)
            ],
            DIRECTION: [
                RegexHandler(backRegex, back_direction, pass_user_data=True),
                MessageHandler(Filters.text, direction_choice, pass_user_data=True)
            ],
            GROUP: [
                RegexHandler(backRegex, back_group, pass_user_data=True),
                MessageHandler(Filters.text, group_choice, pass_user_data=True)
            ],
        },

        fallbacks=[
            CommandHandler('cancel', cancel)
        ],

        allow_reentry = False
    )

    dp.add_handler(conv_handler)
    dp.add_handler(CommandHandler('timetable', timetable_command, pass_user_data=True))

    dp.add_error_handler(error)

    updater.start_polling()
    
    logger.info("Started")
    updater.idle()

if __name__ == '__main__':
    main()